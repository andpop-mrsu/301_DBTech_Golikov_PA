
-- Удаление таблиц (если существуют) в обратном порядке зависимостей
DROP TABLE IF EXISTS credits;
DROP TABLE IF EXISTS exams;
DROP TABLE IF EXISTS students;
DROP TABLE IF EXISTS groups;
DROP TABLE IF EXISTS curriculum;
DROP TABLE IF EXISTS subjects;
DROP TABLE IF EXISTS directions;

-- Таблица направлений подготовки
CREATE TABLE directions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL UNIQUE,
    degree_level VARCHAR(50) NOT NULL CHECK (degree_level IN ('Бакалавриат', 'Магистратура', 'Специалитет'))
);

-- Таблица дисциплин
CREATE TABLE subjects (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL UNIQUE,
    total_hours INTEGER NOT NULL CHECK (total_hours > 0),
    lecture_hours INTEGER NOT NULL DEFAULT 0 CHECK (lecture_hours >= 0),
    practice_hours INTEGER NOT NULL DEFAULT 0 CHECK (practice_hours >= 0),
    assessment_type VARCHAR(20) NOT NULL CHECK (assessment_type IN ('зачет', 'экзамен')),
    CONSTRAINT hours_check CHECK (lecture_hours + practice_hours <= total_hours)
);

-- Таблица учебных планов (связь направления и дисциплины)
CREATE TABLE curriculum (
    id SERIAL PRIMARY KEY,
    direction_id INTEGER NOT NULL REFERENCES directions(id) ON DELETE CASCADE,
    subject_id INTEGER NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
    semester INTEGER NOT NULL CHECK (semester >= 1 AND semester <= 12),
    UNIQUE(direction_id, subject_id, semester)
);

-- Таблица групп
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    direction_id INTEGER NOT NULL REFERENCES directions(id) ON DELETE RESTRICT,
    study_year INTEGER NOT NULL CHECK (study_year >= 1 AND study_year <= 6),
    academic_year VARCHAR(20) NOT NULL, -- например, "2020/2021"
    UNIQUE(name, direction_id, study_year, academic_year)
);

-- Таблица студентов
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    last_name VARCHAR(100) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    middle_name VARCHAR(100),
    birth_date DATE NOT NULL CHECK (birth_date >= '1950-01-01' AND birth_date <= CURRENT_DATE),
    gender CHAR(1) NOT NULL CHECK (gender IN ('M', 'F')),
    group_id INTEGER NOT NULL REFERENCES groups(id) ON DELETE RESTRICT,
    enrollment_date DATE NOT NULL DEFAULT CURRENT_DATE CHECK (enrollment_date >= '2000-01-01')
);

-- Таблица экзаменов
CREATE TABLE exams (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
    subject_id INTEGER NOT NULL REFERENCES subjects(id) ON DELETE RESTRICT,
    grade INTEGER NOT NULL CHECK (grade >= 2 AND grade <= 5),
    exam_date DATE NOT NULL DEFAULT CURRENT_DATE CHECK (exam_date >= '2000-01-01' AND exam_date <= CURRENT_DATE),
    academic_year VARCHAR(20) NOT NULL,
    UNIQUE(student_id, subject_id, academic_year)
);

-- Таблица зачетов
CREATE TABLE credits (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
    subject_id INTEGER NOT NULL REFERENCES subjects(id) ON DELETE RESTRICT,
    passed BOOLEAN NOT NULL DEFAULT FALSE,
    credit_date DATE NOT NULL DEFAULT CURRENT_DATE CHECK (credit_date >= '2000-01-01' AND credit_date <= CURRENT_DATE),
    academic_year VARCHAR(20) NOT NULL,
    UNIQUE(student_id, subject_id, academic_year)
);


-- Направления подготовки
INSERT INTO directions (name, degree_level) VALUES
('Прикладная математика и информатика', 'Бакалавриат'),
('Математика и компьютерные науки', 'Бакалавриат'),
('Прикладная информатика', 'Бакалавриат'),
('Математика', 'Магистратура'),
('Информатика и вычислительная техника', 'Бакалавриат');

-- Дисциплины
INSERT INTO subjects (name, total_hours, lecture_hours, practice_hours, assessment_type) VALUES
('Математический анализ', 144, 72, 72, 'экзамен'),
('Алгебра и геометрия', 108, 54, 54, 'экзамен'),
('Дискретная математика', 108, 54, 54, 'экзамен'),
('Программирование', 144, 36, 108, 'экзамен'),
('Базы данных', 108, 36, 72, 'экзамен'),
('Операционные системы', 72, 36, 36, 'зачет'),
('Компьютерные сети', 72, 36, 36, 'зачет'),
('Теория вероятностей и математическая статистика', 108, 72, 36, 'экзамен'),
('Машинное обучение', 72, 36, 36, 'экзамен'),
('Веб-программирование', 108, 36, 72, 'экзамен'),
('Алгоритмы и структуры данных', 108, 54, 54, 'экзамен'),
('Физика', 108, 72, 36, 'экзамен'),
('Иностранный язык', 72, 36, 36, 'зачет'),
('Философия', 72, 72, 0, 'зачет'),
('История', 72, 72, 0, 'зачет');

INSERT INTO curriculum (direction_id, subject_id, semester) VALUES
(1, 1, 1),  -- Математический анализ, 1 семестр
(1, 1, 2),  -- Математический анализ, 2 семестр
(1, 2, 1),  -- Алгебра и геометрия, 1 семестр
(1, 3, 2),  -- Дискретная математика, 2 семестр
(1, 4, 1),  -- Программирование, 1 семестр
(1, 4, 2),  -- Программирование, 2 семестр
(1, 5, 3),  -- Базы данных, 3 семестр
(1, 6, 3),  -- Операционные системы, 3 семестр
(1, 7, 4),  -- Компьютерные сети, 4 семестр
(1, 8, 3),  -- Теория вероятностей, 3 семестр
(1, 9, 5),  -- Машинное обучение, 5 семестр
(1, 10, 4), -- Веб-программирование, 4 семестр
(1, 11, 3), -- Алгоритмы и структуры данных, 3 семестр
(1, 12, 1), -- Физика, 1 семестр
(1, 13, 1), -- Иностранный язык, 1 семестр
(1, 13, 2), -- Иностранный язык, 2 семестр
(1, 14, 2), -- Философия, 2 семестр
(1, 15, 1); -- История, 1 семестр

-- Учебные планы для направления "Математика и компьютерные науки"
INSERT INTO curriculum (direction_id, subject_id, semester) VALUES
(2, 1, 1),
(2, 1, 2),
(2, 2, 1),
(2, 3, 2),
(2, 4, 1),
(2, 5, 3),
(2, 8, 3),
(2, 11, 3);

INSERT INTO groups (name, direction_id, study_year, academic_year) VALUES
-- Группы направления "Прикладная математика и информатика"
('303', 1, 3, '2020/2021'),
('304', 1, 3, '2020/2021'),
('403', 1, 4, '2021/2022'),
('404', 1, 4, '2021/2022'),
('501', 1, 1, '2022/2023'),
('502', 1, 1, '2022/2023'),
-- Группы направления "Математика и компьютерные науки"
('201', 2, 2, '2020/2021'),
('202', 2, 2, '2020/2021'),
('301', 2, 3, '2021/2022');

INSERT INTO students (last_name, first_name, middle_name, birth_date, gender, group_id, enrollment_date) VALUES
-- Группа 303 (2020/2021, 3 курс)
('Иванов', 'Иван', 'Иванович', '2001-05-15', 'M', 1, '2018-09-01'),
('Петрова', 'Мария', 'Сергеевна', '2001-08-22', 'F', 1, '2018-09-01'),
('Сидоров', 'Алексей', 'Владимирович', '2001-03-10', 'M', 1, '2018-09-01'),
('Козлова', 'Анна', 'Дмитриевна', '2001-11-30', 'F', 1, '2018-09-01'),
('Морозов', 'Дмитрий', 'Александрович', '2001-07-05', 'M', 1, '2018-09-01'),

-- Группа 304 (2020/2021, 3 курс)
('Волкова', 'Елена', 'Игоревна', '2001-04-18', 'F', 2, '2018-09-01'),
('Новиков', 'Сергей', 'Петрович', '2001-09-12', 'M', 2, '2018-09-01'),
('Федорова', 'Ольга', 'Николаевна', '2001-12-25', 'F', 2, '2018-09-01'),
('Смирнов', 'Андрей', 'Викторович', '2001-06-08', 'M', 2, '2018-09-01'),
('Лебедева', 'Татьяна', 'Александровна', '2001-02-14', 'F', 2, '2018-09-01'),

-- Группа 403 (2021/2022, 4 курс) - бывшая 303
('Соколов', 'Павел', 'Игоревич', '2000-10-20', 'M', 3, '2017-09-01'),
('Михайлова', 'Екатерина', 'Сергеевна', '2000-01-28', 'F', 3, '2017-09-01'),
('Кузнецов', 'Роман', 'Дмитриевич', '2000-05-03', 'M', 3, '2017-09-01'),

-- Группа 404 (2021/2022, 4 курс) - бывшая 304
('Орлова', 'Наталья', 'Владимировна', '2000-08-15', 'F', 4, '2017-09-01'),
('Попов', 'Игорь', 'Александрович', '2000-03-22', 'M', 4, '2017-09-01'),

-- Группа 501 (2022/2023, 1 курс)
('Васильев', 'Александр', 'Николаевич', '2004-07-10', 'M', 5, '2022-09-01'),
('Романова', 'Виктория', 'Андреевна', '2004-11-05', 'F', 5, '2022-09-01'),
('Григорьев', 'Максим', 'Сергеевич', '2004-02-18', 'M', 5, '2022-09-01'),

-- Группа 502 (2022/2023, 1 курс)
('Титова', 'Дарья', 'Ивановна', '2004-09-30', 'F', 6, '2022-09-01'),
('Белов', 'Никита', 'Дмитриевич', '2004-04-12', 'M', 6, '2022-09-01'),

-- Группа 201 (2020/2021, 2 курс) - направление "Математика и компьютерные науки"
('Семенов', 'Артем', 'Владимирович', '2002-06-20', 'M', 7, '2019-09-01'),
('Антонова', 'Юлия', 'Сергеевна', '2002-08-14', 'F', 7, '2019-09-01');

INSERT INTO exams (student_id, subject_id, grade, exam_date, academic_year) VALUES
-- Иванов Иван
(1, 1, 5, '2021-01-15', '2020/2021'),  -- Математический анализ
(1, 2, 4, '2021-01-20', '2020/2021'),  -- Алгебра и геометрия
(1, 3, 5, '2021-06-10', '2020/2021'),  -- Дискретная математика
(1, 4, 5, '2021-06-15', '2020/2021'),  -- Программирование
(1, 5, 4, '2021-12-20', '2021/2022'),  -- Базы данных
(1, 8, 5, '2021-12-25', '2021/2022'),  -- Теория вероятностей
(1, 11, 4, '2021-12-18', '2021/2022'), -- Алгоритмы и структуры данных

-- Петрова Мария
(2, 1, 4, '2021-01-15', '2020/2021'),
(2, 2, 4, '2021-01-20', '2020/2021'),
(2, 3, 4, '2021-06-10', '2020/2021'),
(2, 4, 5, '2021-06-15', '2020/2021'),
(2, 5, 5, '2021-12-20', '2021/2022'),
(2, 8, 4, '2021-12-25', '2021/2022'),
(2, 11, 5, '2021-12-18', '2021/2022'),

-- Сидоров Алексей
(3, 1, 3, '2021-01-15', '2020/2021'),
(3, 2, 3, '2021-01-20', '2020/2021'),
(3, 3, 4, '2021-06-10', '2020/2021'),
(3, 4, 3, '2021-06-15', '2020/2021'),
(3, 5, 4, '2021-12-20', '2021/2022'),
(3, 8, 3, '2021-12-25', '2021/2022'),
(3, 11, 4, '2021-12-18', '2021/2022'),

-- Козлова Анна
(4, 1, 5, '2021-01-15', '2020/2021'),
(4, 2, 5, '2021-01-20', '2020/2021'),
(4, 3, 5, '2021-06-10', '2020/2021'),
(4, 4, 5, '2021-06-15', '2020/2021'),
(4, 5, 5, '2021-12-20', '2021/2022'),
(4, 8, 5, '2021-12-25', '2021/2022'),
(4, 11, 5, '2021-12-18', '2021/2022'),

-- Морозов Дмитрий
(5, 1, 2, '2021-01-15', '2020/2021'),
(5, 2, 3, '2021-01-20', '2020/2021'),
(5, 3, 2, '2021-06-10', '2020/2021'),
(5, 4, 3, '2021-06-15', '2020/2021'),
(5, 5, 3, '2021-12-20', '2021/2022'),
(5, 8, 2, '2021-12-25', '2021/2022'),
(5, 11, 3, '2021-12-18', '2021/2022'),

-- Волкова Елена (группа 304)
(6, 1, 4, '2021-01-15', '2020/2021'),
(6, 2, 5, '2021-01-20', '2020/2021'),
(6, 3, 4, '2021-06-10', '2020/2021'),
(6, 4, 4, '2021-06-15', '2020/2021'),
(6, 5, 5, '2021-12-20', '2021/2022'),
(6, 8, 4, '2021-12-25', '2021/2022'),
(6, 11, 4, '2021-12-18', '2021/2022'),

-- Новиков Сергей (группа 304)
(7, 1, 5, '2021-01-15', '2020/2021'),
(7, 2, 5, '2021-01-20', '2020/2021'),
(7, 3, 5, '2021-06-10', '2020/2021'),
(7, 4, 5, '2021-06-15', '2020/2021'),
(7, 5, 5, '2021-12-20', '2021/2022'),
(7, 8, 5, '2021-12-25', '2021/2022'),
(7, 11, 5, '2021-12-18', '2021/2022'),

-- Федорова Ольга (группа 304)
(8, 1, 3, '2021-01-15', '2020/2021'),
(8, 2, 4, '2021-01-20', '2020/2021'),
(8, 3, 3, '2021-06-10', '2020/2021'),
(8, 4, 4, '2021-06-15', '2020/2021'),
(8, 5, 4, '2021-12-20', '2021/2022'),
(8, 8, 4, '2021-12-25', '2021/2022'),
(8, 11, 4, '2021-12-18', '2021/2022'),

-- Соколов Павел (группа 403, 4 курс)
(11, 5, 5, '2021-12-20', '2021/2022'),  -- Базы данных
(11, 9, 4, '2022-06-15', '2021/2022'),  -- Машинное обучение
(11, 10, 5, '2022-06-20', '2021/2022'), -- Веб-программирование

-- Михайлова Екатерина (группа 403, 4 курс)
(12, 5, 5, '2021-12-20', '2021/2022'),
(12, 9, 5, '2022-06-15', '2021/2022'),
(12, 10, 4, '2022-06-20', '2021/2022'),

-- Васильев Александр (группа 501, 1 курс)
(16, 1, 4, '2023-01-20', '2022/2023'),  -- Математический анализ
(16, 2, 5, '2023-01-25', '2022/2023'),  -- Алгебра и геометрия
(16, 4, 4, '2023-06-15', '2022/2023'),  -- Программирование
(16, 12, 4, '2023-01-30', '2022/2023'), -- Физика

-- Романова Виктория (группа 501, 1 курс)
(17, 1, 5, '2023-01-20', '2022/2023'),
(17, 2, 5, '2023-01-25', '2022/2023'),
(17, 4, 5, '2023-06-15', '2022/2023'),
(17, 12, 5, '2023-01-30', '2022/2023'),

-- Семенов Артем (группа 201, направление "Математика и компьютерные науки")
(19, 1, 4, '2021-01-15', '2020/2021'),
(19, 2, 4, '2021-01-20', '2020/2021'),
(19, 3, 5, '2021-06-10', '2020/2021'),
(19, 4, 4, '2021-06-15', '2020/2021');

-- Зачеты
INSERT INTO credits (student_id, subject_id, passed, credit_date, academic_year) VALUES
-- Иванов Иван
(1, 6, TRUE, '2021-12-15', '2021/2022'),   -- Операционные системы
(1, 7, TRUE, '2022-06-10', '2021/2022'),   -- Компьютерные сети
(1, 13, TRUE, '2021-06-05', '2020/2021'),  -- Иностранный язык
(1, 14, TRUE, '2021-06-08', '2020/2021'),  -- Философия
(1, 15, TRUE, '2021-01-10', '2020/2021'),  -- История

-- Петрова Мария
(2, 6, TRUE, '2021-12-15', '2021/2022'),
(2, 7, TRUE, '2022-06-10', '2021/2022'),
(2, 13, TRUE, '2021-06-05', '2020/2021'),
(2, 14, TRUE, '2021-06-08', '2020/2021'),
(2, 15, TRUE, '2021-01-10', '2020/2021'),

-- Сидоров Алексей
(3, 6, TRUE, '2021-12-15', '2021/2022'),
(3, 7, FALSE, '2022-06-10', '2021/2022'), -- Не сдал
(3, 13, TRUE, '2021-06-05', '2020/2021'),
(3, 14, TRUE, '2021-06-08', '2020/2021'),
(3, 15, TRUE, '2021-01-10', '2020/2021'),

-- Козлова Анна
(4, 6, TRUE, '2021-12-15', '2021/2022'),
(4, 7, TRUE, '2022-06-10', '2021/2022'),
(4, 13, TRUE, '2021-06-05', '2020/2021'),
(4, 14, TRUE, '2021-06-08', '2020/2021'),
(4, 15, TRUE, '2021-01-10', '2020/2021'),

-- Морозов Дмитрий
(5, 6, FALSE, '2021-12-15', '2021/2022'), -- Не сдал
(5, 7, FALSE, '2022-06-10', '2021/2022'), -- Не сдал
(5, 13, TRUE, '2021-06-05', '2020/2021'),
(5, 14, FALSE, '2021-06-08', '2020/2021'), -- Не сдал
(5, 15, TRUE, '2021-01-10', '2020/2021'),

-- Волкова Елена
(6, 6, TRUE, '2021-12-15', '2021/2022'),
(6, 7, TRUE, '2022-06-10', '2021/2022'),
(6, 13, TRUE, '2021-06-05', '2020/2021'),
(6, 14, TRUE, '2021-06-08', '2020/2021'),
(6, 15, TRUE, '2021-01-10', '2020/2021'),

-- Новиков Сергей
(7, 6, TRUE, '2021-12-15', '2021/2022'),
(7, 7, TRUE, '2022-06-10', '2021/2022'),
(7, 13, TRUE, '2021-06-05', '2020/2021'),
(7, 14, TRUE, '2021-06-08', '2020/2021'),
(7, 15, TRUE, '2021-01-10', '2020/2021'),

-- Федорова Ольга
(8, 6, TRUE, '2021-12-15', '2021/2022'),
(8, 7, TRUE, '2022-06-10', '2021/2022'),
(8, 13, TRUE, '2021-06-05', '2020/2021'),
(8, 14, TRUE, '2021-06-08', '2020/2021'),
(8, 15, TRUE, '2021-01-10', '2020/2021'),

-- Соколов Павел (4 курс)
(11, 6, TRUE, '2020-12-15', '2020/2021'),
(11, 7, TRUE, '2021-06-10', '2020/2021'),

-- Михайлова Екатерина (4 курс)
(12, 6, TRUE, '2020-12-15', '2020/2021'),
(12, 7, TRUE, '2021-06-10', '2020/2021'),

-- Васильев Александр (1 курс)
(16, 13, TRUE, '2023-06-05', '2022/2023'),  -- Иностранный язык
(16, 15, TRUE, '2023-01-10', '2022/2023'),  -- История

-- Романова Виктория (1 курс)
(17, 13, TRUE, '2023-06-05', '2022/2023'),
(17, 15, TRUE, '2023-01-10', '2022/2023'),

-- Семенов Артем
(19, 13, TRUE, '2021-06-05', '2020/2021'),
(19, 14, TRUE, '2021-06-08', '2020/2021'),
(19, 15, TRUE, '2021-01-10', '2020/2021');


CREATE INDEX idx_students_group ON students(group_id);
CREATE INDEX idx_exams_student ON exams(student_id);
CREATE INDEX idx_exams_subject ON exams(subject_id);
CREATE INDEX idx_exams_academic_year ON exams(academic_year);
CREATE INDEX idx_credits_student ON credits(student_id);
CREATE INDEX idx_credits_subject ON credits(subject_id);
CREATE INDEX idx_credits_academic_year ON credits(academic_year);
CREATE INDEX idx_curriculum_direction ON curriculum(direction_id);
CREATE INDEX idx_curriculum_subject ON curriculum(subject_id);
CREATE INDEX idx_groups_direction ON groups(direction_id);

